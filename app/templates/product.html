{% extends "base.html" %}

{% block content %}

<main>
    <div class="prod-container">
      <div class="grid second-nav">
        <div class="column-xs-12">
        </div>
      </div>
      {% for product in avail_products%}
        <div class="grid product">
          <div class="column-xs-12 column-md-7">
            <div class="product-gallery">
              <div class="product-image">
                <img class="active" src="{{product.image_url}}">
              </div>
              <ul class="image-list">
                <li class="image-item"><img src="{{product.image_url}}"></li>
              </ul>
            </div>
          </div>
          <div class="column-xs-12 column-md-5">
            <h1>{{product.name}}</h1>
            <h2>${{product.price}}</h2>
            <div class="description">
              <h4>Rating: {{product.rating}}/5.0</h4>
              <p>{{product.description_short}}</p>
              <p>{{product.description_long}}</p>
            </div>
            <button class="add-to-cart" onclick="addToCart({{product.id}})">Add To Cart</button>
            <button class="add-to-cart" onclick="writeReview({{ product.id }})">Write a Review</button> 
          </div>
        </div>
      {% endfor %}
      <div class="grid related-products">
        <!-- <div class="column-xs-12">
          <h3>You may also like</h3>
        </div>
        <div class="column-xs-12 column-md-4">
          <img src="https://source.unsplash.com/miziNqvJx5M">
          <h4>Succulent</h4>
          <p class="price">$19.99</p>
        </div>
        <div class="column-xs-12 column-md-4">
          <img src="https://source.unsplash.com/2y6s0qKdGZg">
          <h4>Terranium</h4>
          <p class="price">$19.99</p>
        </div>
        <div class="column-xs-12 column-md-4">
          <img src="https://source.unsplash.com/6Rs76hNbIWE">
          <h4>Cactus</h4>
          <p class="price">$19.99</p>
        </div> -->
      </div>
    </div>
</main>

<table class='table table-hover table-bordered container'>
  <thead class="thead-dark">
    <tr>
      <th scope="col">Product ID</th>
      <th scope="col">Product Name</th>
      <th scope="col">Price</th>
      <th scope="col">Rating</th>
    </tr>
  </thead>
  <tbody>
    {% for product in avail_products%}
      <tr>
        <th scope="row">{{product.id}}</th>
        <td>{{product.name}}</td>
        <td>{{product.price}}</td>
        <td>{{product.rating}}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

<script>
    function addToCart(pid) {
      window.location.href = "/carts/" + pid;
      alert("Added product " + pid + " to cart!");
    }

    const activeImage = document.querySelector(".product-image .active");
    const productImages = document.querySelectorAll(".image-list img");
    const navItem = document.querySelector('a.toggle-nav');

    function changeImage(e) {
    activeImage.src = e.target.src;
    }

    function toggleNavigation(){
    this.nextElementSibling.classList.toggle('active');
    }

    productImages.forEach(image => image.addEventListener("click", changeImage));
    navItem.addEventListener('click', toggleNavigation);
  </script>

  <script>
    function writeReview(productId) {
    // Use prompt to get the rating
    var rating = prompt("Please enter your rating (1-5):", "");
    // Use prompt to get the review text
    var review = prompt("Please enter your review:", "");

    // Check if both rating and review are provided
    if (rating && review) {
        // Ask for confirmation before submitting
        var isConfirmed = confirm("Are you sure you want to submit your review?");
        
        if (isConfirmed) {
            // Prepare the data to be sent to the server
            var reviewData = {
                user_id: 1, //current_user.id, // Assuming you have access to current_user's ID
                product_id: productId, // productId,
                rating: rating,
                comment: review
            };

            // Make an AJAX POST request to submit the review
            fetch('/submit_review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(reviewData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // If the review was successfully submitted
                    alert("Your review has been submitted.");
                    // Redirect to the reviews page
                    window.location.href = "http://localhost:8080/reviews";
                } else {
                    // If there was an error submitting the review
                    alert("Error submitting review: " + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("An error occurred while submitting your review.");
            });
        } else {
            // Handle the case where the user decides not to submit the review
            alert("Your review was not submitted.");
        }
    } else {
        // Handle the case where the user leaves the prompt empty or clicks cancel
        alert("You must enter both a rating and a review to submit.");
    }
}

</script>

{% endblock %}

